# MongoDB University M201 学习笔记



MongoDB大约每个连接需要使用 1MB 的内存。



## 一、索引

### 什么是索引？

- 索引增加会降低写入(新增、删除、修改)速度。
- 索引提高查询效率。



### 索引如何工作？


不同磁盘类型的 IOPS

![1599274624994](images/1599274624994.png)







```bash
m201
jN5426q5jA9jl91C


mongo "mongodb+srv://cluster0.nak8d.azure.mongodb.net/<dbname>" --username m201
```

```bash
$ # Example for my local cluster running on port 27017

$ mongoimport -d m201 -c people --drop people.json

$ mongoimport -d m201 -c restaurants --drop restaurants.json


# 需要身份验证时
$ mongoimport -u 用户名 -p 密码 --authenticationDatabase admin -d m201 -c people --drop people.json
```



```bash
$ # Example for my Atlas cluster, you will need to change the
$ # user, password and Atlas cluster name

$ mongoimport --drop -c people --uri mongodb+srv://theusername:thepassword@m201-nhtgi.mongodb.net/m201 people.json

$ mongoimport --drop -c restaurants --uri mongodb+srv://theusername:thepassword@m201-nhtgi.mongodb.net/m201 restaurants.json
```



### 单字段索引（Single Field Indexes）

```javascript
db.<collection>.createIndex({ <field>: <direction>})
```

### 复合索引





### 多键索引

多键索引（顾明思议就是一个文档可以产生多个健的索引，也就是数组字段的索引）

多键索引没有覆盖查询。

创建索引时不能2个字段同时是数组。



### 部分索引

稀疏索引是一个特殊的部分索引。



### 文本索引

```js
// 创建文本索引
db.products.createIndex({productName:"text"})

// 查询 (默认情况下文本索引不区分大小写)
db.products.find({$text:{$search:"t-shirt"}})
```



```js
// 查询
db.blog.insert({context:"java hello"})
db.blog.insert({context:"java 是一门很好的语言"})
// $search 中文本在逻辑上是“或”， 也就是查询 context 中包含 “Java” 或 “语言”
db.blog.find({$text:{$search:"java 语言"}})

// 显示查询结果的匹配度
db.blog.find({$text:{$search:"java 语言"}}, {score: {$meta:"textScore"}});

// 按照匹配度排序
db.blog.find({$text:{$search:"java 语言"}}, {score: {$meta:"textScore"}}).sort({score: {$meta:"textScore"}});
```





### 通配符索引

```js
// 通配符索引即文档中所有字段都创建索引
db.data.createIndex({"$**":1});

// 索引在 a.b 及其子路径上
db.data.createIndex({"a.b.$**":1});

// 索引在除了a 所有的字段上
db.data.createIndex({"$**":1},{wildcardProjection:{a:0}});

// 索引在 a 及其子路径上
db.data.createIndex({"$**":1},{wildcardProjection:{a:1}});
```



```javascript
// 不带参数时，默认是 queryPlanner 参数方式解析（不会实际执行查询）
// var exp = db.account.explain();  // 和下面的是等价的
var exp = db.account.explain("queryPlanner");
exp.find({usertype:2})


// 使用 executionStats 参数，返回查询相关的统计信息(会实际执行查询)
var expRun = db.account.explain("executionStats");
expRun.find({usertype:2})


// 使用 allPlansExecution 参数，返回所有的查询相关的统计信息(会实际执行查询)
var expRunVerbose = db.account.explain("allPlansExecution");
expRunVerbose.find({usertype:2})

```







查询谓词中字段的顺序无关紧要。

```js
db.person.createIndex({name:1,age:1});

// 以下两个写法的查询对索引的选择没有影响
db.person.find({name:"张三", age: 30});
db.person.find({age: 30, name:"张三"});
```



```bash
# directoryperdb 参数用于设置数据库不同库存储在不同的文件目录（即每个数据库都有对应的文件夹）
mongod --dbpath /data/db --fork --logpath /data/db/mongodb.log --directoryperdb


# --wiredTigerDirectoryForIndexes 设置索引和集合存储在不同文件目录中（索引存储在 index 目录， 集合存储在 collection 目录）
mongod --dbpath /data/db --fork --logpath /data/db/mongodb.log --directoryperdb --wiredTigerDirectoryForIndexes
```



```bash
# 关闭 mongod 服务
mongo admin --eval 'db.shutdownServer()'
```

